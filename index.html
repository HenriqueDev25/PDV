<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Louisiana PDV - Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --bg-dark: #0f1115; --accent-green: #22c55e; --card: #1a1d23; }
        body { font-family: sans-serif; background-color: var(--bg-dark); color: white; margin: 0; overflow: hidden; }
        #loadingScreen { position: fixed; inset: 0; z-index: 999; background: var(--bg-dark); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 4px solid #1a1d23; border-top: 4px solid var(--accent-green); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden-app { display: none !important; }
        .tab-content { display: none; padding: 20px; height: calc(100vh - 80px); overflow-y: auto; }
        .tab-content.active { display: block; }
        .glass { background: var(--card); border: 1px solid #334155; border-radius: 1rem; }
        .img-preview { width: 100%; height: 120px; object-fit: cover; border-radius: 0.5rem; background: #000; }
        input, select { background: #0f1115 !important; border: 1px solid #334155 !important; color: white !important; border-radius: 0.5rem; padding: 10px; }
    </style>
</head>
<body>

<div id="loadingScreen">
    <div class="spinner"></div>
    <p class="mt-4 text-xs font-bold text-gray-500 uppercase tracking-widest">Iniciando Louisiana PDV...</p>
</div>

<div id="appInterface" class="hidden-app h-screen flex flex-col">
    <header class="h-20 p-4 bg-black flex justify-between items-center border-b border-gray-800">
        <h1 class="text-xl font-bold text-green-500 italic">LOUISIANA <span class="text-white">PDV</span></h1>
        <nav class="flex gap-2">
            <button onclick="switchTab('venda')" class="px-6 py-2 bg-gray-800 hover:bg-green-600 rounded-lg font-bold transition">Vendas</button>
            <button onclick="switchTab('estoque')" class="px-6 py-2 bg-gray-800 hover:bg-green-600 rounded-lg font-bold transition">Estoque</button>
            <button onclick="switchTab('config')" class="px-6 py-2 bg-gray-800 hover:bg-green-600 rounded-lg font-bold transition">Config</button>
        </nav>
        <button onclick="logout()" class="text-red-500 font-bold">SAIR</button>
    </header>

    <main class="flex-1 relative">
        <section id="venda" class="tab-content active">
            <div class="flex gap-6 h-full">
                <div class="flex-1 flex flex-col">
                    <input type="text" id="inputBusca" placeholder="Pesquisar produto... (F8)" class="w-full p-4 glass mb-4 text-lg" oninput="renderizarProdutos()">
                    <div id="gridProdutos" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 overflow-y-auto pr-2"></div>
                </div>
                
                <div class="w-96 glass p-6 flex flex-col shadow-2xl">
                    <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">Checkout</h2>
                    <div id="carrinhoItens" class="flex-1 overflow-auto space-y-3 mb-4"></div>
                    
                    <div class="space-y-4 border-t border-gray-700 pt-4">
                        <div class="flex justify-between text-3xl font-black text-green-500">
                            <span>TOTAL:</span> <span id="totalVenda">R$ 0,00</span>
                        </div>
                        
                        <div>
                            <label class="text-xs font-bold text-gray-400">FORMA DE PAGAMENTO</label>
                            <select id="metodoPgto" class="w-full mt-1" onchange="atualizarInterfacePgto()">
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="Cartão">Cartão</option>
                                <option value="PIX">PIX</option>
                            </select>
                        </div>

                        <div id="painelDinheiro" class="bg-black/50 p-4 rounded-lg space-y-3">
                            <div>
                                <label class="text-xs font-bold text-blue-400">VALOR RECEBIDO</label>
                                <input type="number" id="valorRecebido" class="w-full mt-1 text-2xl text-blue-500 font-bold" placeholder="0,00" oninput="calcularTroco()">
                            </div>
                            <div class="flex justify-between items-center bg-blue-500/10 p-2 rounded">
                                <span class="text-sm font-bold">TROCO:</span>
                                <span id="valorTroco" class="text-2xl font-black text-blue-400">R$ 0,00</span>
                            </div>
                        </div>

                        <button onclick="finalizarVenda()" class="w-full bg-green-500 hover:bg-green-400 p-5 rounded-xl font-black text-black text-lg shadow-lg shadow-green-500/20 transition-all">
                            FINALIZAR E IMPRIMIR (F9)
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section id="estoque" class="tab-content">
            <div class="max-w-5xl mx-auto">
                <div class="glass p-6 mb-8">
                    <h2 class="text-xl font-bold mb-4 text-green-500">Cadastrar / Editar Produto</h2>
                    <form id="formProd" class="grid grid-cols-4 gap-4">
                        <input type="hidden" id="editId">
                        <input type="text" id="nome" placeholder="Nome do Produto" class="col-span-2" required>
                        <input type="number" id="qtd" placeholder="Qtd Estoque" required>
                        <input type="number" id="preco" step="0.01" placeholder="Preço Venda" required>
                        <input type="text" id="imgUrl" placeholder="URL da Imagem (Link)" class="col-span-3">
                        <button type="submit" class="bg-green-500 text-black font-bold rounded-lg">SALVAR NO ESTOQUE</button>
                    </form>
                </div>
                <div id="listaEstoque" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </section>

        <section id="config" class="tab-content">
            <div class="max-w-md mx-auto glass p-8">
                <h2 class="text-2xl font-bold mb-6 text-green-500">Configurações</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm mb-1">Nome da Empresa no Recibo</label>
                        <input type="text" id="cfgNomeLoja" class="w-full">
                    </div>
                    <div>
                        <label class="block text-sm mb-1">Tamanho da Bobina</label>
                        <select id="cfgPapel" class="w-full">
                            <option value="58mm">58mm (Padrão)</option>
                            <option value="80mm">80mm</option>
                        </select>
                    </div>
                    <button onclick="salvarConfig()" class="w-full bg-blue-600 py-3 rounded-lg font-bold">Salvar Configurações</button>
                </div>
            </div>
        </section>
    </main>
</div>

<div id="loginScreen" class="hidden-app fixed inset-0 flex items-center justify-center bg-black z-[100]">
    <div class="glass p-10 w-96 text-center">
        <h2 class="text-3xl font-black mb-8 text-green-500">LOGIN</h2>
        <div class="space-y-4">
            <input type="email" id="loginEmail" placeholder="E-mail" class="w-full">
            <input type="password" id="loginPassword" placeholder="Senha" class="w-full">
            <button onclick="fazerLogin()" class="w-full bg-green-500 p-3 text-black font-black rounded-xl hover:scale-105 transition">ENTRAR NO SISTEMA</button>
        </div>
        <p id="loginError" class="text-red-500 mt-4 hidden font-bold text-sm">Usuário ou senha inválidos.</p>
    </div>
</div>

<iframe id="printFrame" style="display:none;"></iframe>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, writeBatch, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBuob65d4nwic1hXTGSsLtc38dEoD1H0zU",
        authDomain: "pdv26-aa76b.firebaseapp.com",
        projectId: "pdv26-aa76b",
        storageBucket: "pdv26-aa76b.firebasestorage.app",
        messagingSenderId: "885941177258",
        appId: "1:885941177258:web:98f2690e07ec0a087cf9d3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let produtos = [], carrinho = [];
    let config = JSON.parse(localStorage.getItem('pdv_cfg')) || { nome: "LOUISIANA PDV", papel: "58mm" };

    // CONTROLE DE ACESSO
    onAuthStateChanged(auth, (user) => {
        document.getElementById('loadingScreen').style.display = 'none';
        if (user && user.email === "louisianapdv@gmail.com") {
            document.getElementById('appInterface').classList.remove('hidden-app');
            document.getElementById('loginScreen').classList.add('hidden-app');
            
            // Sincronizar Produtos
            onSnapshot(collection(db, "produtos"), (snap) => {
                produtos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                window.renderizarProdutos();
                window.renderizarEstoque();
            });
        } else {
            document.getElementById('loginScreen').classList.remove('hidden-app');
            document.getElementById('appInterface').classList.add('hidden-app');
        }
    });

    // Timeout de segurança para o loading
    setTimeout(() => document.getElementById('loadingScreen').style.display = 'none', 2000);

    // FUNÇÕES DE PRODUTO
    window.renderizarProdutos = () => {
        const grid = document.getElementById('gridProdutos');
        const busca = document.getElementById('inputBusca').value.toLowerCase();
        grid.innerHTML = produtos.filter(p => p.nome.toLowerCase().includes(busca)).map(p => `
            <div class="glass p-3 cursor-pointer hover:border-green-500 transition-all group" onclick="window.addCarrinho('${p.id}')">
                <img src="${p.imgUrl || 'https://placehold.co/150x120/1a1d23/white?text=Sem+Foto'}" class="img-preview mb-2 group-hover:scale-105 transition">
                <p class="font-bold text-sm truncate uppercase">${p.nome}</p>
                <div class="flex justify-between items-center mt-2">
                    <span class="text-green-500 font-black">R$ ${parseFloat(p.preco).toFixed(2)}</span>
                    <span class="text-[10px] text-gray-500 font-bold">${p.estoque} UN</span>
                </div>
            </div>
        `).join('');
    };

    window.renderizarEstoque = () => {
        const lista = document.getElementById('listaEstoque');
        lista.innerHTML = produtos.map(p => `
            <div class="glass p-4 flex gap-4 items-center">
                <img src="${p.imgUrl || ''}" class="w-16 h-16 object-cover rounded bg-black">
                <div class="flex-1">
                    <p class="font-bold uppercase text-sm">${p.nome}</p>
                    <p class="text-xs text-gray-400">Preço: R$ ${parseFloat(p.preco).toFixed(2)} | Estoque: ${p.estoque}</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.editarProduto('${p.id}')" class="p-2 bg-blue-600 rounded text-xs">EDITAR</button>
                    <button onclick="window.excluirProduto('${p.id}')" class="p-2 bg-red-600 rounded text-xs">X</button>
                </div>
            </div>
        `).join('');
    };

    // LOGICA DO CARRINHO E TROCO
    window.addCarrinho = (id) => {
        const p = produtos.find(x => x.id === id);
        if(!p || p.estoque <= 0) return alert("Produto sem estoque!");
        const item = carrinho.find(i => i.id === id);
        if(item) {
            if(item.qtd < p.estoque) item.qtd++;
            else return alert("Limite de estoque atingido");
        } else {
            carrinho.push({...p, qtd: 1});
        }
        window.atualizarCarrinho();
    };

    window.atualizarCarrinho = () => {
        const lista = document.getElementById('carrinhoItens');
        let total = 0;
        lista.innerHTML = carrinho.map((item, idx) => {
            total += (item.preco * item.qtd);
            return `<div class="flex justify-between items-center bg-white/5 p-3 rounded-lg border-l-2 border-green-500">
                <div class="text-xs">
                    <p class="font-bold uppercase">${item.nome}</p>
                    <p class="text-gray-400">${item.qtd}x R$ ${parseFloat(item.preco).toFixed(2)}</p>
                </div>
                <button onclick="window.removerItem(${idx})" class="text-red-500 font-bold px-2">×</button>
            </div>`;
        }).join('');
        document.getElementById('totalVenda').innerText = `R$ ${total.toFixed(2)}`;
        calcularTroco();
    };

    window.removerItem = (idx) => { carrinho.splice(idx, 1); window.atualizarCarrinho(); };

    window.atualizarInterfacePgto = () => {
        const isDinheiro = document.getElementById('metodoPgto').value === "Dinheiro";
        document.getElementById('painelDinheiro').style.display = isDinheiro ? 'block' : 'none';
        if(!isDinheiro) {
            document.getElementById('valorRecebido').value = "";
            document.getElementById('valorTroco').innerText = "R$ 0,00";
        }
    };

    window.calcularTroco = () => {
        const total = parseFloat(document.getElementById('totalVenda').innerText.replace("R$ ", "")) || 0;
        const recebido = parseFloat(document.getElementById('valorRecebido').value) || 0;
        const troco = recebido - total;
        document.getElementById('valorTroco').innerText = troco > 0 ? `R$ ${troco.toFixed(2)}` : "R$ 0,00";
    };

    // FINALIZAÇÃO E IMPRESSÃO
    window.finalizarVenda = async () => {
        if(!carrinho.length) return alert("Carrinho vazio!");
        const total = parseFloat(document.getElementById('totalVenda').innerText.replace("R$ ", ""));
        const recebido = parseFloat(document.getElementById('valorRecebido').value) || 0;
        const metodo = document.getElementById('metodoPgto').value;

        if(metodo === "Dinheiro" && recebido < total) return alert("Valor recebido insuficiente!");

        const batch = writeBatch(db);
        carrinho.forEach(item => {
            batch.update(doc(db, "produtos", item.id), { estoque: item.estoque - item.qtd });
        });

        await addDoc(collection(db, "vendas"), {
            data: new Date().toISOString(),
            total,
            pagamento: metodo,
            itens: carrinho.map(i => `${i.qtd}x ${i.nome}`).join(", ")
        });

        await batch.commit();
        window.imprimir(total, recebido, metodo);
        
        carrinho = [];
        document.getElementById('valorRecebido').value = "";
        window.atualizarCarrinho();
        alert("Venda realizada com sucesso!");
    };

    window.imprimir = (total, recebido, metodo) => {
        const frame = document.getElementById('printFrame');
        const largura = config.papel === "80mm" ? "72mm" : "48mm";
        const troco = recebido - total;
        
        const html = `<html><body style="width:${largura};font-family:monospace;font-size:12px;margin:0;padding:10px;">
            <center><b style="font-size:14px;">${config.nome}</b><br>RECIBO DE VENDA</center>
            <hr>
            ${carrinho.map(i => `${i.qtd}x ${i.nome.substring(0,15)}... R$${(i.preco*i.qtd).toFixed(2)}<br>`).join('')}
            <hr>
            <b>TOTAL: R$ ${total.toFixed(2)}</b><br>
            PAGAMENTO: ${metodo}<br>
            ${metodo === "Dinheiro" ? `RECEBIDO: R$ ${recebido.toFixed(2)}<br>TROCO: R$ ${troco.toFixed(2)}` : ""}
            <hr><center>OBRIGADO E VOLTE SEMPRE!</center>
            </body></html>`;
            
        frame.contentWindow.document.open();
        frame.contentWindow.document.write(html);
        frame.contentWindow.document.close();
        setTimeout(() => frame.contentWindow.print(), 500);
    };

    // GESTÃO DE ESTOQUE (SALVAR)
    document.getElementById('formProd').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('editId').value;
        const dados = {
            nome: document.getElementById('nome').value,
            preco: parseFloat(document.getElementById('preco').value),
            estoque: parseInt(document.getElementById('qtd').value),
            imgUrl: document.getElementById('imgUrl').value
        };
        if(id) await updateDoc(doc(db, "produtos", id), dados);
        else await addDoc(collection(db, "produtos"), dados);
        e.target.reset();
        document.getElementById('editId').value = "";
    };

    window.editarProduto = (id) => {
        const p = produtos.find(x => x.id === id);
        document.getElementById('editId').value = id;
        document.getElementById('nome').value = p.nome;
        document.getElementById('preco').value = p.preco;
        document.getElementById('qtd').value = p.estoque;
        document.getElementById('imgUrl').value = p.imgUrl || "";
    };

    window.excluirProduto = async (id) => { if(confirm("Excluir produto definitivamente?")) await deleteDoc(doc(db, "produtos", id)); };

    // AUTH E TABS
    window.fazerLogin = async () => {
        try {
            await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value);
        } catch (e) { document.getElementById('loginError').classList.remove('hidden'); }
    };
    window.logout = () => signOut(auth);
    window.switchTab = (id) => {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'venda') document.getElementById('inputBusca').focus();
    };
    window.salvarConfig = () => {
        config = { nome: document.getElementById('cfgNomeLoja').value, papel: document.getElementById('cfgPapel').value };
        localStorage.setItem('pdv_cfg', JSON.stringify(config));
        alert("Configurações salvas!");
    };

    // ATALHOS
    window.addEventListener('keydown', (e) => {
        if(e.key === 'F8') { e.preventDefault(); document.getElementById('inputBusca').focus(); }
        if(e.key === 'F9') window.finalizarVenda();
    });

    // Iniciar dados config
    document.getElementById('cfgNomeLoja').value = config.nome;
    document.getElementById('cfgPapel').value = config.papel;
    window.atualizarInterfacePgto();
</script>
</body>
</html>
